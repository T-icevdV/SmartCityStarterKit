!function(){"use strict";var a,b=new WeakMap;if("function"==typeof require&&null!=typeof exports){a=exports;var c=require("whatwg-url").URL}else{a={};var c=window.URL}a.endpoints={REGISTER_CONTEXT:"v1/registry/registerContext",DISCOVER_CONTEXT_AVAILABILITY:"v1/registry/discoverContextAvailability",SUBSCRIBE_CONTEXT_AVAILABILITY:"v1/registry/subscribeContextAvailability",UPDATE_CONTEXT_AVAILABILITY_SUBSCRIPTION:"v1/registry/updateContextAvailabilitySubscription",UNSUBSCRIBE_CONTEXT_AVAILABILITY:"v1/registry/unsubscribeContextAvailability",QUERY_CONTEXT:"v1/queryContext",UPDATE_CONTEXT:"v1/updateContext",SUBSCRIBE_CONTEXT:"v1/subscribeContext",UPDATE_CONTEXT_SUBSCRIPTION:"v1/updateContextSubscription",UNSUBSCRIBE_CONTEXT:"v1/unsubscribeContext",CONTEXT_TYPES:"v1/contextTypes",v2:{BATCH_QUERY_OP:"v2/op/query",BATCH_UPDATE_OP:"v2/op/update",ENTITY_ATTRS_COLLECTION:"v2/entities/%(entityId)s/attrs",ENTITY_ATTR_ENTRY:"v2/entities/%(entityId)s/attrs/%(attribute)s",ENTITY_ATTR_VALUE_ENTRY:"v2/entities/%(entityId)s/attrs/%(attribute)s/value",ENTITY_COLLECTION:"v2/entities",ENTITY_ENTRY:"v2/entities/%(entityId)s",SUBSCRIPTION_COLLECTION:"v2/subscriptions",SUBSCRIPTION_ENTRY:"v2/subscriptions/%(subscriptionId)s",TYPE_COLLECTION:"v2/types",TYPE_ENTRY:"v2/types/%(typeId)s"}},a.proxy_endpoints={EVENTSOURCE_COLLECTION:"eventsource",CALLBACK_COLLECTION:"callbacks"};var d=function(a,b){return a.replace(/%\(\w+\)s/g,function(a){return String(b[a.slice(2,-2)])})},e=function(b,c,d,e,f){var g,h=null,i=null;null!=c&&(i="application/json",h=JSON.stringify(c)),g=JSON.parse(JSON.stringify(this.request_headers)),g.Accept="application/json",this.makeRequest(b,{method:null!=h?"POST":"GET",contentType:i,requestHeaders:g,parameters:f,postBody:h}).then(function(b){var c;if(200!==b.status)"function"==typeof e.onFailure&&(c=b instanceof a.ConnectionError?b:[0,502,504].indexOf(b.status)!==-1?new a.ConnectionError("Connection Error"):new a.InvalidResponseError("Unexpected error code: "+b.status),e.onFailure(c));else if("function"==typeof e.onSuccess){var f;try{try{f=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content")}f=d(f,e)}catch(a){return"function"==typeof e.onFailure&&e.onFailure(a),void("function"==typeof e.onComplete&&e.onComplete())}e.onSuccess.apply(null,f)}"function"==typeof e.onComplete&&e.onComplete()},function(b){if("function"==typeof e.onFailure){b instanceof a.ConnectionError||(b=new a.ConnectionError);try{e.onFailure(b)}catch(a){}}"function"==typeof e.onComplete&&e.onComplete()})},f=function(a,b){var c=a.trim().toLowerCase(),d=Object.keys(b),e=d.map(function(a){return a.trim().toLowerCase()}).indexOf(c);e!==-1&&delete b[d[e]]},g=function(b,c){null!=c.postBody&&(c.contentType="application/json",c.postBody=JSON.stringify(c.postBody));var d=JSON.parse(JSON.stringify(this.request_headers));d.Accept="application/json";for(var e in c.requestHeaders)null!=c.requestHeaders[e]&&(f(e,d),d[e]=c.requestHeaders[e]);return c.requestHeaders=d,this.makeRequest(b,c).then(function(b){return[0,502,504].indexOf(b.status)!==-1?Promise.reject(new a.ConnectionError):Promise.resolve(b)},function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})},h=function(a){var b,c;return c="string"==typeof a.isPattern&&"true"===a.isPattern.trim().toLowerCase()||a.isPattern===!0,b={id:""+a.id,isPattern:""+c},null!=a.type&&(b.type=""+a.type),b},i=function(a){var b,c,d;if("polygon"in a.value){for(b={polygon:{vertices:[]}},c=0;c<a.value.polygon.vertices.length;c++)d=a.value.polygon.vertices[c],b.polygon.vertices.push({latitude:""+d.latitude,longitude:""+d.longitude});a.value.polygon.inverted&&(b.polygon.inverted="true")}else"circle"in a.value&&(b={circle:{centerLatitude:""+a.value.circle.centerLatitude,centerLongitude:""+a.value.circle.centerLongitude,radius:a.value.circle.radius}},a.value.circle.inverted&&(b.circle.inverted="true"));return b},j=function(a){var b,c;if(b={scopes:[]},Array.isArray(a.scopes))for(c=0;c<a.scopes.length;c++)b.scopes.push({type:a.scopes[c].type,value:i(a.scopes[c])});return b},k=function(a){var b,c;for(b=[],c=0;c<a.length;c++)b.push({name:""+a[c].name,type:""+a[c].type,value:""+a[c].value});return b},l=function(a,b,c,d,e){var f,g,i,j;for(f={contextRegistrations:[{entities:[],attributes:[],providingApplication:d}],duration:""+c},g=0;g<a.length;g+=1)f.contextRegistrations[0].entities.push(h(a[g]));for(g=0;g<b.length;g+=1)i=b[g],j={name:i.name,isDomain:"false"},null!=i.type&&(j.type=""+i.type),f.contextRegistrations[0].attributes.push(j);return null!=e&&(f.registrationId=""+e),f},m=function(a,b,c){var d,e;for(d={entities:[]},e=0;e<a.length;e+=1)d.entities.push(h(a[e]));if(Array.isArray(b)&&b.length>0)for(d.attributes=[],e=0;e<b.length;e+=1)d.attributes.push(""+b[e]);return null!=c&&(d.restriction=j(c)),d},n=function(a,b){var c,d,e,f,g,i,j,l,m;for(c={contextElements:[],updateAction:a},d=0;d<b.length;d+=1){if(f=h(b[d].entity),i=b[d].attributes,null!=i)for(g=f.attributes=[],e=0;e<i.length;e+=1)j=i[e],l={name:""+j.name},null!=j.type&&(l.type=""+j.type),"DELETE"!==a&&(m=null!=j.value?j.value:null!=j.contextValue?j.contextValue:null,l.value=m),Array.isArray(j.metadata)&&j.metadata.length>0&&(l.metadatas=k(j.metadata)),g.push(l);c.contextElements.push(f)}return c},o=function(a,b){var c,d;for(c={entities:[],attributes:b},d=0;d<a.length;d+=1)c.entities.push(h(a[d]));return c},p=function(a,b,c,d,e,f){var g,i;for(g=e?{entities:[],subscriptionId:e}:{entities:[],reference:f},i=0;i<a.length;i+=1)g.entities.push(h(a[i]));return Array.isArray(b)&&b.length>0&&(g.attributes=b),null!=c&&(g.duration=""+c),null!=d&&(g.restriction=j(d)),g},q=function(a){return{subscriptionId:a}},r=function(a,b,c,d,e,f,g){var i,j,k,l;if(a)i={subscriptionId:a};else{for(i={entities:[],reference:g},j=0;j<b.length;j+=1)i.entities.push(h(b[j]));Array.isArray(c)&&(i.attributes=c)}if(null!=d&&(i.duration=""+d),Array.isArray(f))for(i.notifyConditions=[],j=0;j<f.length;j+=1)k=f[j],l={type:k.type},i.notifyConditions.push(l),Array.isArray(k.condValues)&&(l.condValues=k.condValues);return null!=e&&(i.throttling=""+e),i},s=function(a){return{subscriptionId:a}},t=function(a,b,c){return null!=a.type&&(c.type=a.type,delete a.type),b.keyValues===!0&&(c.options="keyValues"),delete a.id,a},u=function(b){if(D(b),"object"!=typeof b||"string"!=typeof b.registrationId||"string"!=typeof b.duration)throw new a.InvalidResponseError("The server returned an invalid json structure");return[b]},v=function(a){var b,c,d,e=[];for(d=0;d<a.length;d+=1)b=a[d].contextRegistration,c={entities:[],attributes:[],providingApplication:b.providingApplication},null!=b.entities&&(c.entities=b.entities),null!=b.attributes&&(c.attributes=b.attributes),e.push(c);return e},w=function(b){if("object"!=typeof b||Array.isArray(b))throw new a.InvalidResponseError("The server returned an invalid json structure");if(D(b),!Array.isArray(b.contextRegistrationResponses))throw new a.InvalidResponseError("The server returned an invalid json structure");return[v(b.contextRegistrationResponses)]},x=function(b){if(D(b),"string"!=typeof b.subscriptionId)throw new a.InvalidResponseError("The server returned an invalid json structure");if("duration"in b&&"string"!=typeof b.duration)throw new a.InvalidResponseError("The server returned an invalid json structure");return[b]},y=function(b){if("object"!=typeof b||Array.isArray(b)||!("subscriptionId"in b))throw new a.InvalidResponseError("The server returned an invalid json structure");return[{subscriptionId:b.subscriptionId,statusCode:C(b)}]},z=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n;for(f=!!c.flat,j=f?{}:[],n=[],b&&(i=""),g=0;g<a.length;g+=1){if(d=a[g].contextElement,m=C(a[g]),e=f?{}:{entity:null,attributes:[]},200===m.code&&f?(e.id=d.id,e.type=d.type):e.entity={id:d.id,type:d.type},null!=d.attributes)for(h=0;h<d.attributes.length;h+=1)k=d.attributes[h],b||(i=k.value),f?e[k.name]=i:(l={name:k.name,type:k.type},b||(l.value=i),null!=k.metadatas&&(l.metadata=k.metadatas),e.attributes.push(l));200===m.code?f?j[d.id]=e:j.push(e):(b&&(e.statusCode=m),n.push(e))}return[j,n]},A=function(b,c){var d,e,f;if(e=C(b),404===e.code){if("string"==typeof e.details&&(d=e.details.match(F),d&&(f=e.details={text:e.details,matches:parseInt(d[1]),offset:parseInt(d[2])})),c.details&&(f={count:0}),0!==c.offset)throw e;return[[],f]}if(200!==e.code)throw new a.InvalidResponseError("Unexpected error code");return"string"==typeof e.details&&(d=e.details.match(E),d&&(f={count:parseInt(d[1],10)})),[b.types,f]},B=function(b){var c;if("object"!=typeof b||Array.isArray(b))throw new a.InvalidResponseError("The server returned an invalid json structure");if(c=C(b),404===c.code)throw new a.NotFoundError({details:b,message:c.reasonPhrase});if(200!==c.code)throw new a.InvalidResponseError("Unexpected error code");return delete b.statusCode,[b]},C=function(b){if(!("statusCode"in b))throw new a.InvalidResponseError("missing response status code info");return b.statusCode.code=parseInt(b.statusCode.code,10),b.statusCode},D=function(b){if("errorCode"in b)throw new a.InvalidRequestError(parseInt(b.errorCode.code,10),b.errorCode.reasonPhrase,b.errorCode.details)},E=new RegExp("Count: (\\d+)"),F=new RegExp("Number of matching entities: (\\d+). Offset is (\\d+)"),G=function(b,c){var d,e,f;if("object"!=typeof b||Array.isArray(b))throw new a.InvalidResponseError("The server returned an invalid json structure");try{D(b)}catch(a){switch(a.code){case 200:e=a.details.match(E),e&&(d={count:parseInt(e[1],10)});break;case 404:if(f=c.flat?{}:[],e=a.details.match(F),e?d=a.details={text:a.details,matches:parseInt(e[1]),offset:parseInt(e[2])}:c.details===!0&&0===c.offset&&(d=a.details={count:0}),0!==c.offset)throw a;return[f,d];default:throw a}}if(!Array.isArray(b.contextResponses))throw new a.InvalidResponseError("The server returned an invalid json structure");return[z(b.contextResponses,!1,c)[0],d]},H=function(a,b){return D(a),z(a.contextResponses,!0,b)},I=function(b){if(D(b),"string"!=typeof b.subscriptionId)throw new a.InvalidResponseError("The server returned an invalid json structure");if("duration"in b&&"string"!=typeof b.duration)throw new a.InvalidResponseError("The server returned an invalid json structure");if("throttling"in b&&"string"!=typeof b.throttling)throw new a.InvalidResponseError("The server returned an invalid json structure");return b},J=function(b){if(D(b),"object"!=typeof b||"object"!=typeof b.subscribeResponse)throw new a.InvalidResponseError("The server returned an invalid json structure");return[I(b.subscribeResponse)]},K=function(b){if(D(b),"object"!=typeof b||"object"!=typeof b.subscribeResponse)throw new a.InvalidResponseError("The server returned an invalid json structure");return[I(b.subscribeResponse)]},L=function(b){if(D(b),"object"!=typeof b||"string"!=typeof b.subscriptionId)throw new a.InvalidResponseError("The server returned an invalid json structure");return b.statusCode=C(b),[b]},M=function(b,c){if("object"!=typeof b||Array.isArray(b)||!Array.isArray(b.contextRegistrationResponses))throw new a.InvalidResponseError("The server returned an invalid json structure");return[v(b.contextRegistrationResponses)]},N=function(a,b){var c={};if(null!=a.limit){if("number"!=typeof a.limit||a.limit<20)throw new TypeError("invalid value for the limit option");c.limit=a.limit}if(null!=a.offset){if("number"!=typeof a.offset||a.offset<0)throw new TypeError("invalid value for the offset option");c.offset=a.offset}else a.offset=0;if(null!=b)if(null!=a.details){if("boolean"!=typeof a.details)throw new TypeError("invalid value for the details option");a.details?c.details="on":c.details="off"}else c.details=b,a.details="on"===b;return c},O=function(a,b){var c={};if(null!=a.limit){if("number"!=typeof a.limit||!Number.isInteger(a.limit)||a.limit<1)throw new TypeError("invalid value for the limit option");c.limit=a.limit}else a.limit=20;if(null!=a.offset){if("number"!=typeof a.offset||!Number.isInteger(a.offset)||a.offset<0)throw new TypeError("invalid value for the offset option");c.offset=a.offset}else a.offset=0;if(null!=a.count){if("boolean"!=typeof a.count)throw new TypeError("invalid value for the count option");b.push("count")}return c},P=function(a){if("application/json"!==a.getHeader("Content-Type"))throw new TypeError("Unexpected response mimetype");return JSON.parse(a.responseText)};a.parseNotifyContextRequest=function(a,b){return{elements:z(a.contextResponses,!1,b)[0],subscriptionId:a.subscriptionId,originator:a.originator}};var Q=function(){return this.makeRequest(new c(a.proxy_endpoints.EVENTSOURCE_COLLECTION,this.url),{supportsAccessControl:!0,method:"POST"}).then(function(c){if([0,502,504].indexOf(c.status)!==-1)return b.get(this).promise=null,Promise.reject(new a.ConnectionError);if(201!==c.status)return b.get(this).promise=null,Promise.reject(new a.InvalidResponseError("Unexpected error code: "+c.status));var d=b.get(this);return d.source_url=c.getHeader("Location"),null==d.source_url?Promise.reject(new a.InvalidResponseError("Missing Location Header")):R.call(this)}.bind(this),function(c){return b.get(this).promise=null,c instanceof a.ConnectionError||(c=new a.ConnectionError),Promise.reject(c)}.bind(this))},R=function(){return new Promise(function(c,d){var e,f=null,g=b.get(this),h=function(a){var b=JSON.parse(a.data);clearTimeout(e),g.promise=null,g.connection_id=b.id,g.source.removeEventListener("init",f,!0),g.source.addEventListener("notification",function(a){var b=JSON.parse(a.data);g.callbacks[b.callback_id].method(b.payload,b.headers)}.bind(this),!0),c()};f=h.bind(this),g.source=new EventSource(g.source_url),g.source.addEventListener("init",f,!0),e=setTimeout(function(){g.promise=null,g.source.close(),g.source=null,d(new a.ConnectionError("Connection timeout"))}.bind(this),3e4)}.bind(this))},S=function(){var a={},c=b.get(this).callbacks;for(var d in c)a[d]=c[d].subscription;return a},T=function(){var a=b.get(this);return null!=a.source&&null!=a.connection_id},U=function(){return null!==b.get(this).promise},V=function(){return b.get(this).connection_id},W=function(){var a={},c=b.get(this).callbacksBySubscriptionId;for(var d in c)a[d]=c[d].callback_id;return a};a.ProxyConnection=function(a,d){try{a=new c(a)}catch(a){throw new TypeError("invalid url parameter")}if("http:"!==a.protocol&&"https:"!==a.protocol)throw new TypeError("unsupported protocol: "+a.protocol.substr(0,a.protocol.length-1));"/"!==a.pathname[a.pathname.length-1]&&(a.pathname+="/"),this.makeRequest=d,b.set(this,{callbacks:{},callbacksBySubscriptionId:{},connected:!1,connection_id:null,promise:null,source:null}),Object.defineProperties(this,{callbackSubscriptions:{get:S},connected:{get:T},connecting:{get:U},connection_id:{get:V},subscriptionCallbacks:{get:W},url:{value:a}})},a.ProxyConnection.prototype.connect=function(){if(this.connected===!0)return Promise.resolve();var a=b.get(this);return null===a.promise&&(a.promise=Q.call(this)),a.promise},a.ProxyConnection.prototype.requestCallback=function(c){if("function"!=typeof c)throw new TypeError("callback parameter must be a function");return this.connect().then(function(){return this.makeRequest(this.url+a.proxy_endpoints.CALLBACK_COLLECTION,{supportsAccessControl:!0,method:"POST",contentType:"application/json",postBody:JSON.stringify({connection_id:this.connection_id})}).then(function(d){if([200,201].indexOf(d.status)===-1)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+d.status));var e=JSON.parse(d.responseText),f=b.get(this);return f.callbacks[e.callback_id]={callback_id:e.callback_id,method:c,subscription:null},Promise.resolve(e)}.bind(this),function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})}.bind(this))},a.ProxyConnection.prototype.close=function(){if(this.connected===!1)return Promise.resolve();var c=b.get(this);return this.makeRequest(c.source_url,{supportsAccessControl:!0,method:"DELETE"}).then(function(b){return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status)):(c.source.close(),c.source=null,c.connection_id=null,c.callbacks={},void(c.callbacksBySubscriptionId={}))}.bind(this),function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})},a.ProxyConnection.prototype.closeCallback=function(b){return this.makeRequest(this.url+a.proxy_endpoints.CALLBACK_COLLECTION+"/"+b,{supportsAccessControl:!0,method:"DELETE"}).then(function(c){return 204!==c.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+c.status)):void this.purgeCallback(b)}.bind(this),function(b){return b instanceof a.ConnectionError||(b=new a.ConnectionError),Promise.reject(b)})},a.ProxyConnection.prototype.associateSubscriptionId=function(a,c){var d=b.get(this);if(!(a in d.callbacks))return this;if(null!=d.callbacks[a].subscription)throw new TypeError("Already associated callback");return d.callbacksBySubscriptionId[c]=d.callbacks[a],d.callbacks[a].subscription=c,this},a.ProxyConnection.prototype.closeSubscriptionCallback=function(a){var c=b.get(this);return a in c.callbacksBySubscriptionId?this.closeCallback(c.callbacksBySubscriptionId[a].callback_id):Promise.resolve()},a.ProxyConnection.prototype.purgeCallback=function(a){var c=b.get(this);if(a in c.callbacks){var d=c.callbacks[a].subscription;null!=d&&delete c.callbacksBySubscriptionId[d],delete c.callbacks[a]}},a.ConnectionError=function(a){this.name="ConnectionError",this.message=a||"Connection Error"},a.ConnectionError.prototype=new Error,a.ConnectionError.prototype.constructor=a.ConnectionError,a.InvalidRequestError=function(a,b,c){this.name="InvalidRequest",this.code=a,this.message=b||"",this.details=c||""},a.InvalidRequestError.prototype=new Error,a.InvalidRequestError.prototype.constructor=a.InvalidRequestError,a.InvalidResponseError=function(a,b){this.name="InvalidResponse",this.message=a||"",this.correlator=b},a.InvalidResponseError.prototype=new Error,a.InvalidResponseError.prototype.constructor=a.InvalidResponseError,a.NotFoundError=function(a){this.name="NotFound",this.message=a.message||"",this.details=a.details||"",this.correlator=a.correlator||null},a.NotFoundError.prototype=new Error,a.NotFoundError.prototype.constructor=a.NotFoundError,a.ProxyConnectionError=function(a){this.name="ProxyConnectionError",this.cause=a},a.ProxyConnectionError.prototype=new Error,a.ProxyConnectionError.prototype.constructor=a.ProxyConnectionError,a.Connection=function(b,d){try{b=new c(b)}catch(a){throw new TypeError("invalid url parameter")}if("http:"!==b.protocol&&"https:"!==b.protocol)throw new TypeError("unsupported protocol: "+b.protocol.substr(0,b.protocol.length-1));"/"!==b.pathname[b.pathname.length-1]&&(b.pathname+="/"),null==d&&(d={}),null!=d.request_headers?this.request_headers=d.request_headers:this.request_headers={},null!=d.service&&(f("FIWARE-Service",this.request_headers),this.request_headers["FIWARE-Service"]=d.service),null!=d.servicepath&&(f("FIWARE-ServicePath",this.request_headers),this.request_headers["FIWARE-ServicePath"]=d.servicepath),"function"==typeof d.requestFunction&&(this.makeRequest=d.requestFunction),d.ngsi_proxy_connection instanceof a.ProxyConnection?this.ngsi_proxy=d.ngsi_proxy_connection:"string"==typeof d.ngsi_proxy_url&&(this.ngsi_proxy=new a.ProxyConnection(d.ngsi_proxy_url,this.makeRequest)),Object.defineProperties(this,{url:{value:b},v1:{value:this},v2:{value:new a.Connection.V2(this)}})},a.Connection.prototype.createRegistration=function(b,d,f,g,h){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributes parameter must be an array or null");null==d&&(d=[]),null==h&&(h={});var i=l(b,d,f,g),j=new c(a.endpoints.REGISTER_CONTEXT,this.url);e.call(this,j,i,u,h)},a.Connection.prototype.updateRegistration=function(b,d,f,g,h,i){if(!Array.isArray(d)||0===d.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=f&&!Array.isArray(f))throw new TypeError("attributes parameter must be an array or null");null==f&&(f=[]),null==i&&(i={});var j=l(d,f,g,h,b),k=new c(a.endpoints.REGISTER_CONTEXT,this.url);return e.call(this,k,j,u,i)},a.Connection.prototype.cancelRegistration=function(a,b){if(null==a)throw new TypeError("regId parameter cannot be null");this.updateRegistration(a,[{id:"canceled registration"}],[],"PT0H","http://canceled.registration.com",b)},a.Connection.prototype.discoverAvailability=function(b,d,f){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributeNames parameter must be an array or null");null==d&&(d=[]),null==f&&(f={});var g=o(b,d),h=new c(a.endpoints.DISCOVER_CONTEXT_AVAILABILITY,this.url);e.call(this,h,g,w,f)},a.Connection.prototype.createAvailabilitySubscription=function(b,d,f,g,h){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributeNames parameter must be an array or null");if(null==h)throw new TypeError("Missing options parameter");if("string"!=typeof h.onNotify&&"function"!=typeof h.onNotify)throw new TypeError("Invalid onNotify callback");if("function"==typeof h.onNotify&&null==this.ngsi_proxy)throw new TypeError("A ngsi-proxy is needed for using local onNotify callbacks");var i=new c(a.endpoints.SUBSCRIBE_CONTEXT_AVAILABILITY,this.url);if("function"==typeof h.onNotify&&null!=this.ngsi_proxy){var j=function(a){var b=JSON.parse(a),c=M(b,h);h.onNotify(c)};this.ngsi_proxy.requestCallback(j).then(function(a){var c=p(b,d,f,g,null,a.url),j=h.onFailure;h.onFailure=function(){this.ngsi_proxy.closeCallback(a.callback_id),"function"==typeof j&&j.apply(this,arguments)}.bind(this);var k=h.onSuccess;h.onSuccess=function(b){this.ngsi_proxy.associateSubscriptionId(a.callback_id,b.subscriptionId),"function"==typeof k&&k(b)}.bind(this),e.call(this,i,c,x,h)}.bind(this),function(){"function"==typeof h.onFailure&&h.onFailure()})}else{var k=p(b,d,f,g,null,h.onNotify);e.call(this,i,k,x,h)}},a.Connection.prototype.updateAvailabilitySubscription=function(b,d,f,g,h,i){if(null==b)throw new TypeError("subId parameter cannot be null");if(!Array.isArray(d)||0===d.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=f&&!Array.isArray(f))throw new TypeError("attributeNames parameter must be an array or null");null==i&&(i={});var j=p(d,f,g,h,b),k=new c(a.endpoints.UPDATE_CONTEXT_AVAILABILITY_SUBSCRIPTION,this.url);e.call(this,k,j,x,i)},a.Connection.prototype.cancelAvailabilitySubscription=function(b,d){if(null==b)throw new TypeError("subId parameter cannot be null");null==d&&(d={});var f=q(b),g=new c(a.endpoints.UNSUBSCRIBE_CONTEXT_AVAILABILITY,this.url);e.call(this,g,f,y,d)},a.Connection.prototype.query=function(b,d,f){var g,h,i;if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributesName must be null or an array");null==d&&(d=[]),null==f&&(f={}),h=N(f,"off"),g=new c(a.endpoints.QUERY_CONTEXT,this.url),i=m(b,d,f.restriction),e.call(this,g,i,G,f,h)},a.Connection.prototype.updateAttributes=function(b,d){if(!Array.isArray(b)||0===b.length)throw new TypeError("update parameter must be a non-empty array");null==d&&(d={});var f=n("UPDATE",b),g=new c(a.endpoints.UPDATE_CONTEXT,this.url);e.call(this,g,f,H,d)},a.Connection.prototype.addAttributes=function(b,d){if(!Array.isArray(b)||0===b.length)throw new TypeError("toAdd parameter must be a non-empty array");null==d&&(d={});var f=n("APPEND",b),g=new c(a.endpoints.UPDATE_CONTEXT,this.url);e.call(this,g,f,H,d)},a.Connection.prototype.deleteAttributes=function(b,d){if(!Array.isArray(b)||0===b.length)throw new TypeError("toDelete parameter must be a non-empty array");null==d&&(d={});var f=n("DELETE",b),g=new c(a.endpoints.UPDATE_CONTEXT,this.url);e.call(this,g,f,H,d)},a.Connection.prototype.createSubscription=function(b,d,f,g,h,i){if(!Array.isArray(b)||0===b.length)throw new TypeError("entities parameter must be a non-empty array");if(null!=d&&!Array.isArray(d))throw new TypeError("attributeNames parameter must be an array or null");if(null==i)throw new TypeError("Missing options parameter");if("string"!=typeof i.onNotify&&"function"!=typeof i.onNotify)throw new TypeError("Invalid onNotify callback");if("function"==typeof i.onNotify&&null==this.ngsi_proxy)throw new TypeError("A ngsi-proxy is needed for using local onNotify callbacks");var j=new c(a.endpoints.SUBSCRIBE_CONTEXT,this.url);if("function"==typeof i.onNotify&&null!=this.ngsi_proxy){var k=function(b){var c=JSON.parse(b),d=a.parseNotifyContextRequest(c,i);i.onNotify(d)};this.ngsi_proxy.requestCallback(k).then(function(a){var c=r(null,b,d,f,g,h,a.url),k=i.onFailure;i.onFailure=function(){this.ngsi_proxy.closeCallback(a.callback_id),"function"==typeof k&&k.apply(this,arguments)}.bind(this);var l=i.onSuccess;i.onSuccess=function(b){this.ngsi_proxy.associateSubscriptionId(a.callback_id,b.subscriptionId),"function"==typeof l&&l(b)}.bind(this),e.call(this,j,c,J,i)}.bind(this),function(b){if("function"==typeof i.onFailure){var c=new a.ProxyConnectionError(b);try{i.onFailure(c)}catch(a){}}if("function"==typeof i.onComplete)try{i.onComplete()}catch(a){}})}else{var l=r(null,b,d,f,g,h,i.onNotify);e.call(this,j,l,J,i)}},a.Connection.prototype.updateSubscription=function(b,d,f,g,h){if(null==b)throw new TypeError("subId parameter cannot be null");null==h&&(h={});var i=r(b,null,null,d,f,g),j=new c(a.endpoints.UPDATE_CONTEXT_SUBSCRIPTION,this.url);e.call(this,j,i,K,h)},a.Connection.prototype.cancelSubscription=function(b,d){if(null==b)throw new TypeError("subId parameter cannot be null");if(null==d&&(d={}),this.ngsi_proxy){var f=d.onSuccess;d.onSuccess=function(a){this.ngsi_proxy.closeSubscriptionCallback(a.subscriptionId),"function"==typeof f&&f(a)}.bind(this)}var g=s(b),h=new c(a.endpoints.UNSUBSCRIBE_CONTEXT,this.url);e.call(this,h,g,L,d)},a.Connection.prototype.getAvailableTypes=function(b){var d=new c(a.endpoints.CONTEXT_TYPES,this.url),f=N(b,"on");e.call(this,d,null,A,b,f)},a.Connection.prototype.getTypeInfo=function(b,d){if(null==b)throw new TypeError("Invalid type parameter");var f=new c(a.endpoints.CONTEXT_TYPES+"/"+encodeURIComponent(b),this.url);e.call(this,f,null,B,d)},a.Connection.V2=function(a){b.set(this,a)},a.Connection.V2.prototype.listEntities=function(d){if(null==d&&(d={}),null!=d.id&&null!=d.idPattern)throw new TypeError("id and idPattern options cannot be used at the same time");if(null!=d.type&&null!=d.typePattern)throw new TypeError("type and typePattern options cannot be used at the same time");var e=b.get(this),f=new c(a.endpoints.v2.ENTITY_COLLECTION,e.url),h=[],i=O(d,h);return d.keyValues===!0&&h.push("keyValues"),d.values===!0&&h.push("values"),d.unique===!0&&h.push("unique"),0!==h.length&&(i.options=h.join(",")),i.attrs=d.attrs,i.id=d.id,i.idPattern=d.idPattern,i.orderBy=d.orderBy,i.metadata=d.metadata,i.mq=d.mq,i.q=d.q,i.type=d.type,i.typePattern=d.typePattern,i.georel=d.georel,i.geometry=d.geometry,i.coords=d.coords,g.call(e,f,{method:"GET",parameters:i,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var e=JSON.parse(b.responseText)}catch(b){return Promise.reject(new a.InvalidResponseError("Server returned invalid JSON content",c))}var f={results:e,limit:d.limit,offset:d.offset,correlator:c};return d.count===!0&&(f.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(f)})},a.Connection.V2.prototype.createEntity=function(d,e){null==e&&(e={});var f=b.get(this),h={};e.keyValues===!0&&(h.options="keyValues");var i=new c(a.endpoints.v2.ENTITY_COLLECTION,f.url);return g.call(f,i,{method:"POST",postBody:d,parameters:h,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 201!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c,entity:d,location:b.getHeader("Location")})})},a.Connection.V2.prototype.getEntity=function(e){if(null==e)throw new TypeError("missing options parameter");"string"==typeof e&&(e={id:e});var f=b.get(this),h=new c(d(a.endpoints.v2.ENTITY_ENTRY,{entityId:encodeURIComponent(e.id)}),f.url),i={};return null!=e.type&&(i.type=e.type),e.keyValues===!0&&(i.options="keyValues"),g.call(f,h,{method:"GET",parameters:i,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,entity:d})})},a.Connection.V2.prototype.getEntityAttributes=function(e){if(null==e)throw new TypeError("missing options parameter");"string"==typeof e&&(e={id:e});var f=b.get(this),h=new c(d(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(e.id)}),f.url),i={};return null!=e.type&&(i.type=e.type),e.keyValues===!0&&(i.options="keyValues"),g.call(f,h,{method:"GET",parameters:i,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({attributes:d,correlator:c})})},a.Connection.V2.prototype.appendEntityAttributes=function(e,f){null==f&&(f={});var h=b.get(this),i=new c(d(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(e.id)}),h.url),j={},k=[];return delete e.id,null!=e.type&&(j.type=e.type,delete e.type),f.strict===!0&&k.push("append"),f.keyValues===!0&&k.push("keyValues"),k.length>0&&(j.options=k.join(",")),g.call(h,i,{method:"POST",parameters:j,postBody:e,requestHeaders:{"FIWARE-Correlator":f.correlator,"FIWARE-Service":f.service,"FIWARE-ServicePath":f.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.updateEntityAttributes=function(e,f){if(null==f&&(f={}),null==e)throw new TypeError("missing changes parameter");var h=b.get(this),i=new c(d(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(e.id)}),h.url),j={};return delete e.id,null!=e.type&&(j.type=e.type,delete e.type),f.keyValues===!0&&(j.options="keyValues"),g.call(h,i,{method:"PATCH",parameters:j,postBody:e,requestHeaders:{"FIWARE-Correlator":f.correlator,"FIWARE-Service":f.service,"FIWARE-ServicePath":f.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.replaceEntityAttributes=function(e,f){null==f&&(f={});var h=b.get(this),i=new c(d(a.endpoints.v2.ENTITY_ATTRS_COLLECTION,{entityId:encodeURIComponent(e.id)}),h.url),j={},k=t(e,f,j);return g.call(h,i,{method:"PUT",postBody:k,parameters:j,requestHeaders:{"FIWARE-Correlator":f.correlator,"FIWARE-Service":f.service,"FIWARE-ServicePath":f.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({
correlator:c,entity:e})})},a.Connection.V2.prototype.deleteEntity=function(e){if(null==e)throw new TypeError("missing options parameter");"string"==typeof e&&(e={id:e});var f=b.get(this),h=new c(d(a.endpoints.v2.ENTITY_ENTRY,{entityId:encodeURIComponent(e.id)}),f.url),i={};return null!=e.type&&(i.type=e.type),g.call(f,h,{method:"DELETE",parameters:i,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(404===b.status){try{var d=P(b)}catch(b){return Promise.reject(new a.InvalidResponseError(null,c))}return Promise.reject(new a.NotFoundError({message:d.description,correlator:c}))}return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.getEntityAttribute=function(c){if(null==c)throw new TypeError("missing options parameter");if(null==c.id)throw new TypeError("missing id option");if(null==c.attribute)throw new TypeError("missing attribute option");var e=b.get(this),f=e.url+d(a.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(c.id),attribute:encodeURIComponent(c.attribute)}),h={};return null!=c.type&&(h.type=c.type),g.call(e,f,{method:"GET",parameters:h,requestHeaders:{"FIWARE-Correlator":c.correlator,"FIWARE-Service":c.service,"FIWARE-ServicePath":c.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status),c);try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,attribute:d})})},a.Connection.V2.prototype.replaceEntityAttribute=function(c,e){if(null==c)throw new TypeError("missing changes parameter");if(null==e&&(e={attribute:c.attribute,correlator:c.correlator,id:c.id,service:c.service,servicepath:c.servicepath,type:c.type}),null==e.id)throw new TypeError("missing id option");if(null==e.attribute)throw new TypeError("missing attribute option");var f={value:c.value,metadata:c.metadata},h=b.get(this),i=h.url+d(a.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(e.id),attribute:encodeURIComponent(e.attribute)}),j={};return null!=e.type&&(j.type=e.type),g.call(h,i,{method:"PUT",parameters:j,postBody:f,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c,attribute:f})})},a.Connection.V2.prototype.deleteEntityAttribute=function(c){if(null==c)throw new TypeError("missing options parameter");if(null==c.id)throw new TypeError("missing id option");if(null==c.attribute)throw new TypeError("missing attribute option");var e=b.get(this),f=e.url+d(a.endpoints.v2.ENTITY_ATTR_ENTRY,{entityId:encodeURIComponent(c.id),attribute:encodeURIComponent(c.attribute)}),h={};return null!=c.type&&(h.type=c.type),g.call(e,f,{method:"DELETE",parameters:h,requestHeaders:{"FIWARE-Correlator":c.correlator,"FIWARE-Service":c.service,"FIWARE-ServicePath":c.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(404===b.status){try{var d=P(b)}catch(b){return Promise.reject(new a.InvalidResponseError(null,c))}return Promise.reject(new a.NotFoundError({message:d.description,correlator:c}))}return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.getEntityAttributeValue=function(c){if(null==c)throw new TypeError("missing options parameter");if(null==c.id)throw new TypeError("missing id option");if(null==c.attribute)throw new TypeError("missing attribute option");var e=b.get(this),f=e.url+d(a.endpoints.v2.ENTITY_ATTR_VALUE_ENTRY,{entityId:encodeURIComponent(c.id),attribute:encodeURIComponent(c.attribute)}),h={};return null!=c.type&&(h.type=c.type),g.call(e,f,{method:"GET",parameters:h,requestHeaders:{Accept:"application/json, text/plain","FIWARE-Correlator":c.correlator,"FIWARE-Service":c.service,"FIWARE-ServicePath":c.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,value:d})})},a.Connection.V2.prototype.replaceEntityAttributeValue=function(c){if(null==c)throw new TypeError("missing options parameter");if(null==c.id)throw new TypeError("missing id option");if(null==c.attribute)throw new TypeError("missing attribute option");if("undefined"==typeof c.value)throw new TypeError("missing value option");var e=b.get(this),f=e.url+d(a.endpoints.v2.ENTITY_ATTR_VALUE_ENTRY,{entityId:encodeURIComponent(c.id),attribute:encodeURIComponent(c.attribute)}),h={};return null!=c.type&&(h.type=c.type),g.call(e,f,{method:"PUT",parameters:h,postBody:c.value,requestHeaders:{"FIWARE-Correlator":c.correlator,"FIWARE-Service":c.service,"FIWARE-ServicePath":c.servicepath}}).then(function(b){var d=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,d)):Promise.resolve({correlator:d,value:c.value})})},a.Connection.V2.prototype.listTypes=function(d){null==d&&(d={});var e=b.get(this),f=new c(a.endpoints.v2.TYPE_COLLECTION,e.url),h=[],i=O(d,h);return d.values===!0&&h.push("values"),0!==h.length&&(i.options=h.join(",")),g.call(e,f,{method:"GET",parameters:i,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));var e={correlator:c,limit:d.limit,offset:d.offset,results:JSON.parse(b.responseText)};return d.count===!0&&(e.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(e)})},a.Connection.V2.prototype.getType=function(e){if(null==e)throw new TypeError("missing options parameter");"string"==typeof e&&(e={id:e});var f=b.get(this),h=new c(d(a.endpoints.v2.TYPE_ENTRY,{typeId:encodeURIComponent(e.id)}),f.url);return g.call(f,h,{method:"GET",requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,type:d})})},a.Connection.V2.prototype.listSubscriptions=function(d){null==d&&(d={});var e=b.get(this),f=new c(a.endpoints.v2.SUBSCRIPTION_COLLECTION,e.url),h=[],i=O(d,h);return 0!==h.length&&(i.options=h.join(",")),g.call(e,f,{method:"GET",parameters:i,requestHeaders:{"FIWARE-Correlator":d.correlator,"FIWARE-Service":d.service,"FIWARE-ServicePath":d.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));var e={correlator:c,limit:d.limit,offset:d.offset,results:JSON.parse(b.responseText)};return d.count===!0&&(e.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(e)})},a.Connection.V2.prototype.createSubscription=function(d,e){var f,h,i=b.get(this);if(null==e&&(e={}),"object"!=typeof d)throw new TypeError("invalid subscription parameter");if("callback"in d.notification){if("function"!=typeof d.notification.callback)throw new TypeError("invalid callback configuration");var j=function(a,b){var c=JSON.parse(a);c.attrsformat=b["ngsiv2-attrsformat"],this(c)}.bind(d.notification.callback);f=i.ngsi_proxy.requestCallback(j).then(function(a){h=a,delete d.notification.callback,d.notification.http={url:h.url}})}else f=Promise.resolve();var k=new c(a.endpoints.v2.SUBSCRIPTION_COLLECTION,i.url);return f.then(function(){return g.call(i,k,{method:"POST",postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}})}).then(function(b){var c=b.getHeader("Fiware-correlator");if(201!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));var e=b.getHeader("Location"),f=e.split("/").pop();return d.id=f,h&&this.ngsi_proxy.associateSubscriptionId(h.callback_id,f),Promise.resolve({correlator:c,subscription:d,location:e})}.bind(i),function(a){return h&&this.ngsi_proxy.closeCallback(h.callback_id),Promise.reject(a)}.bind(i))},a.Connection.V2.prototype.getSubscription=function(e){if(null==e)throw new TypeError("missing options parameter");"string"==typeof e&&(e={id:e});var f=b.get(this),h=new c(d(a.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(e.id)}),f.url);return g.call(f,h,{method:"GET",requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){throw new a.InvalidResponseError("Server returned invalid JSON content",c)}return Promise.resolve({correlator:c,subscription:d})})},a.Connection.V2.prototype.updateSubscription=function(e,f){null==f&&(f={});var h=b.get(this),i=new c(d(a.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(e.id)}),h.url);return delete e.id,g.call(h,i,{method:"PATCH",postBody:e,requestHeaders:{"FIWARE-Correlator":f.correlator,"FIWARE-Service":f.service,"FIWARE-ServicePath":f.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.deleteSubscription=function(e){if(null==e)throw new TypeError("missing options parameter");"string"==typeof e&&(e={id:e});var f=b.get(this),h=new c(d(a.endpoints.v2.SUBSCRIPTION_ENTRY,{subscriptionId:encodeURIComponent(e.id)}),f.url);return g.call(f,h,{method:"DELETE",requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(404===b.status){try{var d=P(b)}catch(b){return Promise.reject(new a.InvalidResponseError(null,c))}return Promise.reject(new a.NotFoundError({message:d.description,correlator:c}))}return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.batchUpdate=function(e,f){if(null==f&&(f={}),null==e)throw new TypeError("missing changes parameter");var h=b.get(this),i=new c(d(a.endpoints.v2.BATCH_UPDATE_OP),h.url),j={};return f.keyValues===!0&&(j.options="keyValues"),g.call(h,i,{method:"POST",parameters:j,postBody:e,requestHeaders:{"FIWARE-Correlator":f.correlator,"FIWARE-Service":f.service,"FIWARE-ServicePath":f.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");return 204!==b.status?Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c)):Promise.resolve({correlator:c})})},a.Connection.V2.prototype.batchQuery=function(d,e){if(null==e&&(e={}),null==d)throw new TypeError("missing query parameter");var f=b.get(this),h=new c(a.endpoints.v2.BATCH_QUERY_OP,f.url),i=[],j=O(e,i);return e.keyValues===!0&&i.push("keyValues"),e.values===!0&&i.push("values"),e.unique===!0&&i.push("unique"),i.length>0&&(j.options=i.join(",")),j.orderBy=e.orderBy,g.call(f,h,{method:"POST",parameters:j,postBody:d,requestHeaders:{"FIWARE-Correlator":e.correlator,"FIWARE-Service":e.service,"FIWARE-ServicePath":e.servicepath}}).then(function(b){var c=b.getHeader("Fiware-correlator");if(200!==b.status)return Promise.reject(new a.InvalidResponseError("Unexpected error code: "+b.status,c));try{var d=JSON.parse(b.responseText)}catch(b){return Promise.reject(new a.InvalidResponseError("Server returned invalid JSON content",c))}var f={correlator:c,limit:e.limit,offset:e.offset,results:d};return e.count===!0&&(f.count=parseInt(b.getHeader("Fiware-Total-Count"),10)),Promise.resolve(f)})},"undefined"!=typeof window&&(window.NGSI=a)}();
//# sourceMappingURL=NGSI.min.js.map